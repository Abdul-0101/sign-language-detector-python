<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Sign Language Live Translator</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Poppins', sans-serif; text-align: center; background: #f0f2f5; margin-top: 20px; }
    video { border: 3px solid #007bff; border-radius: 8px; transform: scaleX(-1); } /* Flip video for viewing only */
    button { margin: 5px; padding: 10px 20px; font-size: 18px; background: #007bff; border: none; color: white; border-radius: 8px; cursor: pointer; }
    button:hover { background: #0056b3; }
    input { margin: 10px; padding: 10px; width: 300px; font-size: 16px; border-radius: 8px; border: 1px solid #ccc; }
    #signPopup { display:none; position:fixed; top:10%; left:10%; width:80%; height:80%; background:white; border:2px solid #007bff; overflow:auto; border-radius:10px; padding:20px;}
    #signPopup img { width:90%; max-width:800px; margin: 10px auto; }
    h1 { color: #333; margin-bottom: 10px; }
    h2 { margin-top: 10px; }
  </style>
</head>
<body>

<h1>ü§ü Sign Language Live Translator</h1>

<video id="video" width="320" height="240" autoplay playsinline></video> <!-- ‚úÖ Smaller video resolution -->
<canvas id="canvas" width="320" height="240" style="display:none;"></canvas>

<h2>Detected Letter: <span id="letter">-</span></h2>
<h2>Full Paragraph:</h2>
<div id="paragraph" style="white-space: pre-wrap; font-size:20px;"></div>

<div id="predictions"></div>

<div>
  <button onclick="backspace()">‚å´</button>
  <button onclick="space()">Space ‚û°</button>
  <button onclick="newline()">New Line ‚Üµ</button>
  <button onclick="speak()">üîà Speak</button>
  <button onclick="clearAll()">üßπ Clear All</button>
  <button onclick="showSigns()">üìö All Signs</button>
</div>

<div>
  <input id="corrected" placeholder="Correct manually...">
  <button onclick="correction()">‚úè Correct</button>
</div>

<!-- Popup for Signs -->
<div id="signPopup">
  <button onclick="hideSigns()">‚ùå Close</button><br><br>
  <img src="https://www.researchgate.net/publication/305110120/figure/fig1/AS:406942804660224@1474034133389/ndian-sign-language-dataset.png" alt="All Signs">
</div>

<script>
const video = document.getElementById('video');
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
const letterSpan = document.getElementById('letter');
const paragraphDiv = document.getElementById('paragraph');
const predictionsDiv = document.getElementById('predictions');

navigator.mediaDevices.getUserMedia({ 
  video: { width: { ideal: 320 }, height: { ideal: 240 } } 
})
.then(stream => { video.srcObject = stream; });

video.addEventListener('play', () => {
  setInterval(async () => {
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
    canvas.toBlob(async blob => {
      const form = new FormData();
      form.append('frame', blob, 'frame.jpg');
      const res = await fetch('/predict', { method: 'POST', body: form });
      const data = await res.json();
      letterSpan.textContent = data.letter || '-';
      paragraphDiv.textContent = data.paragraph || '-';
      suggestWord(data.paragraph.split(' ').pop());
    }, 'image/jpeg', 0.7);  // ‚úÖ Compression set to 70% quality
  }, 500); // ‚úÖ Slower sending rate (500ms)
});

async function suggestWord(partial) {
  if (!partial) return;
  const res = await fetch(`/predict_word?partial=${partial}`);
  const data = await res.json();
  predictionsDiv.innerHTML = data.predictions.map(w => `<button onclick="appendPrediction('${w}')">${w}</button>`).join(' ');
}

function appendPrediction(word) {
  document.getElementById('corrected').value = word;
  correction();
}

function backspace() { fetch('/backspace', { method: 'POST' }).then(r => r.json()).then(d => paragraphDiv.textContent = d.paragraph); }
function space() { fetch('/space', { method: 'POST' }).then(r => r.json()).then(d => paragraphDiv.textContent = d.paragraph); }
function newline() { fetch('/newline', { method: 'POST' }).then(r => r.json()).then(d => paragraphDiv.textContent = d.paragraph); }
function clearAll() { fetch('/clear', { method: 'POST' }).then(r => r.json()).then(d => paragraphDiv.textContent = d.paragraph); }
function speak() { fetch('/speak').then(r => r.json()).then(d => { const audio = new Audio('data:audio/mpeg;base64,' + d.audio); audio.play(); }); }
function correction() {
  const corrected = document.getElementById('corrected').value;
  const form = new FormData();
  form.append('corrected', corrected);
  fetch('/correction', { method: 'POST', body: form }).then(r => r.json()).then(d => paragraphDiv.textContent = d.paragraph);
}

function showSigns() {
  document.getElementById('signPopup').style.display = 'block';
}
function hideSigns() {
  document.getElementById('signPopup').style.display = 'none';
}

// Keyboard keys working
document.addEventListener('keydown', function(event) {
  if (event.key === "Backspace") backspace();
  if (event.key === " ") space();
  if (event.key === "Enter") newline();
});
</script>

</body>
</html>
